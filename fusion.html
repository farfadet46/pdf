<!DOCTYPE html>
<!-- page fusion.html -->
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fusionner des PDF â€” Offline</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<nav style="position:sticky; top:0; z-index:1000; background:var(--panel); backdrop-filter:blur(8px); border-bottom:1px solid rgba(255,255,255,.06); padding:10px 20px; display:flex; gap:12px; justify-content:center;">
  <a href="fusion.html" class="btn btn-ghost">Fusion</a>
  <a href="decoupe.html" class="btn btn-ghost">DÃ©coupage</a>
  <a href="index.html" class="btn btn-ghost">Accueil</a>
</nav>
  <header>
    <h1>Fusionner des PDF</h1>
    <p class="sub">Glissezâ€‘dÃ©posez des fichiers PDF, rÃ©ordonnez, puis cliquez sur Â«Â FusionnerÂ Â».</p>
  </header>

  <div class="container">
    <div class="grid">
      <section class="card">
        <div id="drop" class="dropzone">
          <p><strong>DÃ©posez vos PDF ici</strong> ou</p>
          <p><label class="btn btn-ghost tooltip" for="picker">Choisir des fichiers
				<span class="tooltiptext">Selectionner au moins deux PDF</span>
		  </label></p>
          <input id="picker" type="file" accept="application/pdf" multiple hidden />
          <p class="hint">AstuceÂ : vous pouvez aussi utiliser <span class="kbd">Ctrl</span>/<span class="kbd">Cmd</span> + <span class="kbd">O</span>.</p>
        </div>

        <div class="files" id="fileList" aria-live="polite"></div>

        <div class="foot">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <button id="merge" class="btn-accent tooltip">Fusionner â†’
				<span class="tooltiptext">Cliquez pour fusionner les PDF</span>
			</button>
            <button id="clear" class="btn tooltip">Effacer
				<span class="tooltiptext"> Vider la liste</span>
			</button>
          </div>
          <div class="tooltip">
            <label>Nom du fichierÂ : <input id="outName" value="fusion.pdf" style="padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:var(--text);"/>
				<span class="tooltiptext">Nommez le fichier de sortie</span>
			</label>
          </div>
        </div>
      </section>

      <aside class="card">
        <details open>
          <summary>Fonctionnement</summary>
          <ul>
            <li>Tout se passe dans votre navigateurÂ : aucune donnÃ©e ne quitte votre appareil.</li>
            <li>Les PDF protÃ©gÃ©s par mot de passe ne sont pas pris en charge.</li>
            <li>RÃ©ordonnez les PDF avec â–²/â–¼, supprimez avec âœ•.</li>
          </ul>
        </details>
        <details style="margin-top:10px;">
          <summary>Informations</summary>
          <p>
			Vous avez des remarques ou des idÃ©es dâ€™amÃ©lioration ?  
			Ã‰crivez-moi : <a href="mailto:farfadet46@gmail.com">@farfadet46</a>.
		  </p>
        </details>
      </aside>
    </div>

	<div id="popup" class="popup">
	  <p id="popup-text"></p>
	  <button id="popup-close" class="btn btn-accent">OK</button>
	</div>

    <footer>Fait avec <span aria-hidden="true">ğŸ¤</span> par  <a href="mailto:farfadet46@gmail.com">@farfadet46</a>.</footer>
  </div>

  <!-- BibliothÃ¨que locale pour fonctionner hors-ligne. TÃ©lÃ©chargez une fois pdf-lib.min.js et placez-le Ã  cÃ´tÃ© de ce fichier. -->
  <script src="pdf-lib.min.js"></script>
  <script>
    // ---------------------- UI & liste de fichiers ----------------------
    const picker = document.getElementById('picker');
    const drop = document.getElementById('drop');
    const fileList = document.getElementById('fileList');
    const mergeBtn = document.getElementById('merge');
    const clearBtn = document.getElementById('clear');
    const outName = document.getElementById('outName');

    /** @type {File[]} */
    let files = [];

    function refreshList() {
      fileList.innerHTML = '';
      if (!files.length) {
        const empty = document.createElement('p');
        empty.className = 'hint';
        empty.textContent = 'Aucun fichier sÃ©lectionnÃ©.';
        fileList.appendChild(empty);
        return;
      }
      files.forEach((f, i) => {
        const row = document.createElement('div');
        row.className = 'file';
        row.innerHTML = `
          <div class="name" title="${f.name}">ğŸ“„ ${f.name} <span class="hint">(${Math.round(f.size/1024)}Â Ko)</span></div>
          <div class="row-actions">
            <button title="Monter" data-act="up">â–²</button>
            <button title="Descendre" data-act="down">â–¼</button>
            <button title="Supprimer" data-act="remove">âœ•</button>
          </div>
        `;
        row.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', () => {
            const act = btn.getAttribute('data-act');
            if (act === 'up' && i>0) { [files[i-1], files[i]] = [files[i], files[i-1]]; refreshList(); }
            if (act === 'down' && i<files.length-1) { [files[i+1], files[i]] = [files[i], files[i+1]]; refreshList(); }
            if (act === 'remove') { files.splice(i,1); refreshList(); }
          });
        });
        fileList.appendChild(row);
      });
    }

    function addFiles(fileListLike) {
      const added = Array.from(fileListLike).filter(f => f.type === 'application/pdf');
      files = files.concat(added);
      refreshList();
    }

    picker.addEventListener('change', e => addFiles(e.target.files));

    // Drag & drop
    ;['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); }));
    ;['dragleave','drop'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag'); }));
    drop.addEventListener('drop', e => addFiles(e.dataTransfer.files));

    // Raccourci clavier Ctrl/Cmd + O
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'o') {
        e.preventDefault(); picker.click();
      }
    });

    clearBtn.addEventListener('click', () => { files = []; refreshList(); });

    // ---------------------- Fusion PDF avec pdf-lib ----------------------
    async function mergePDFs(fileArray) {
      if (!window.PDFLib) throw new Error('pdf-lib non chargÃ©. Assurez-vous que "pdf-lib.min.js" est prÃ©sent Ã  cÃ´tÃ© de ce fichier.');
      const { PDFDocument } = window.PDFLib;
      const outPdf = await PDFDocument.create();

      for (const f of fileArray) {
        const buf = await f.arrayBuffer();
        let src;
        try {
          src = await PDFDocument.load(buf, { ignoreEncryption: true });
        } catch (e) {
          throw new Error(`Impossible de lire Â«Â ${f.name}Â Â». Le fichier est peutâ€‘Ãªtre protÃ©gÃ© par mot de passe ou corrompu.`);
        }
        const pages = await outPdf.copyPages(src, src.getPageIndices());
        pages.forEach(p => outPdf.addPage(p));
      }

      const outBytes = await outPdf.save();
      return new Blob([outBytes], { type: 'application/pdf' });
    }

	mergeBtn.addEventListener('click', async () => {
	  // VÃ©rifie qu'au moins 2 fichiers sont sÃ©lectionnÃ©s
	  if (!files || files.length < 2) {
	    showPopup("Veuillez ajouter au moins deux fichiers PDF pour les fusionner.");
		<!-- alert("Veuillez ajouter au moins deux fichiers PDF pour les fusionner."); -->
		return;
	  }

	  mergeBtn.disabled = true;
	  mergeBtn.textContent = 'Fusionâ€¦';

	  try {
		const blob = await mergePDFs(files);
		const name = (outName.value || 'fusion.pdf').replace(/\s+/g,'_');
		const a = document.createElement('a');
		a.href = URL.createObjectURL(blob);
		a.download = name.endsWith('.pdf') ? name : name + '.pdf';
		document.body.appendChild(a);
		a.click();
		a.remove();
		setTimeout(() => URL.revokeObjectURL(a.href), 10000);
	  } catch (err) {
		console.error(err);
		alert(err.message || 'Erreur lors de la fusion.');
	  } finally {
		mergeBtn.disabled = false;
		mergeBtn.textContent = 'Fusionner â†’';
	  }
	});

	const popup = document.getElementById('popup');
	const popupText = document.getElementById('popup-text');
	const popupClose = document.getElementById('popup-close');

	function showPopup(message) {
	  popupText.textContent = message;
	  popup.style.display = 'block';
	}

	popupClose.addEventListener('click', () => {
	  popup.style.display = 'none';
	});


    // Initial render
    refreshList();
  </script>
</body>
</html>
